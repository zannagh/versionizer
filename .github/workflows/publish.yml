name: Build & Publish

on:
  release:
    types: [published]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force create a prerelease even if only non-code files changed'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Run full pipeline without actually publishing'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NUGET_SOURCE: https://nuget.pkg.github.com/zannagh/index.json

jobs:
  # ============================================================================
  # ANALYZE
  # ============================================================================
  analyze:
    name: Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.release-check.outputs.should_release }}
      is_manual_release: ${{ steps.release-check.outputs.is_manual_release }}
      skip_reason: ${{ steps.release-check.outputs.skip_reason }}
      version: ${{ steps.mod-ver.outputs.version }}
      is_prerelease: ${{ steps.mod-ver.outputs.is_prerelease }}
      semver: ${{ steps.version.outputs.majorMinorPatch }}
      full_semver: ${{ steps.version.outputs.fullSemVer }}
      prerelease_number: ${{ steps.version.outputs.preReleaseNumber }}
      commits_since: ${{ steps.version.outputs.commitsSinceVersionSource }}
      config_source: ${{ steps.version.outputs.configSource }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Calculate Version
        id: version
        uses: ./calculate-version

      - name: Debug Version Info
        run: |
          echo "MajorMinorPatch: ${{ steps.version.outputs.majorMinorPatch }}"
          echo "FullSemVer: ${{ steps.version.outputs.fullSemVer }}"
          echo "PreReleaseNumber: ${{ steps.version.outputs.preReleaseNumber }}"
          echo "CommitsSinceVersionSource: ${{ steps.version.outputs.commitsSinceVersionSource }}"
          echo "Config Source: ${{ steps.version.outputs.configSource }}"

      - name: Check Release
        id: release-check
        uses: ./check-release
        with:
          event-name: ${{ github.event_name }}
          is-dry-run: ${{ inputs.dry_run }}
          force-release: ${{ inputs.force_release }}

      - name: Determine Version
        id: mod-ver
        uses: ./determine-version
        with:
          is-manual-release: ${{ steps.release-check.outputs.is_manual_release }}
          release-tag-name: ${{ github.event.release.tag_name }}
          release-prerelease: ${{ github.event.release.prerelease }}
          semver: ${{ steps.version.outputs.majorMinorPatch }}
          prerelease-number: ${{ steps.version.outputs.preReleaseNumber }}
          commits-since: ${{ steps.version.outputs.commitsSinceVersionSource }}

  # ============================================================================
  # VALIDATE VERSION (manual releases only)
  # ============================================================================
  validate-version:
    name: Validate Release Version
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.is_manual_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "Tag version: $VERSION"

          LATEST=$(git tag -l 'v*' --sort=-v:refname | head -n1 | sed 's/^v//' || echo "0.0.0")
          if [[ "$LATEST" == "$VERSION" ]]; then
            LATEST=$(git tag -l 'v*' --sort=-v:refname | sed -n '2p' | sed 's/^v//' || echo "0.0.0")
          fi
          echo "Latest existing version: $LATEST"

          HIGHER=$(echo -e "$VERSION\n$LATEST" | sort -V | tail -n1)
          if [[ "$HIGHER" != "$VERSION" && "$VERSION" != "$LATEST" ]]; then
            echo "::error::Version downgrade detected! New version ($VERSION) is lower than existing version ($LATEST)"
            exit 1
          fi
          echo "Version validation passed: $VERSION >= $LATEST"

  # ============================================================================
  # PACK NUGET
  # ============================================================================
  pack:
    name: Pack NuGet
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.should_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Pack
        working-directory: nuget
        run: |
          dotnet pack -c Release \
            -p:PackageVersion="${{ needs.analyze.outputs.version }}" \
            -p:Version="${{ needs.analyze.outputs.version }}"

      - name: Upload NuGet Artifact
        uses: actions/upload-artifact@v6
        with:
          name: versionizer-${{ needs.analyze.outputs.version }}
          path: nuget/bin/Release/*.nupkg
          if-no-files-found: error

  # ============================================================================
  # GENERATE CHANGELOG
  # ============================================================================
  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: [analyze, pack]
    if: needs.analyze.outputs.should_release == 'true'
    outputs:
      content: ${{ steps.changelog.outputs.content }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate Changelog
        id: changelog
        uses: ./generate-changelog
        with:
          is-manual-release: ${{ needs.analyze.outputs.is_manual_release }}
          release-body: ${{ github.event.release.body }}
          mod-version: ${{ needs.analyze.outputs.version }}
          repository: ${{ github.repository }}

  # ============================================================================
  # CREATE GITHUB PRERELEASE (automatic from main)
  # ============================================================================
  create-prerelease:
    name: Create GitHub Prerelease
    runs-on: ubuntu-latest
    needs: [analyze, pack, changelog]
    if: |
      needs.analyze.outputs.should_release == 'true' &&
      needs.analyze.outputs.is_manual_release != 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create Prerelease
        uses: ./create-prerelease
        with:
          version: ${{ needs.analyze.outputs.version }}
          changelog: ${{ needs.changelog.outputs.content }}
          artifact-name: versionizer-${{ needs.analyze.outputs.version }}
          artifact-pattern: artifacts/**/*.nupkg
          dry-run: ${{ inputs.dry_run }}

  # ============================================================================
  # UPLOAD TO GITHUB RELEASE (manual releases)
  # ============================================================================
  upload-to-release:
    name: Upload to GitHub Release
    runs-on: ubuntu-latest
    needs: [analyze, pack, validate-version]
    if: needs.analyze.outputs.is_manual_release == 'true'
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: artifacts/**/*.nupkg

  # ============================================================================
  # UPDATE MAJOR VERSION TAG (stable manual releases only)
  # ============================================================================
  update-major-tag:
    name: Update Major Version Tag
    runs-on: ubuntu-latest
    needs: [analyze, upload-to-release]
    if: |
      needs.analyze.outputs.is_manual_release == 'true' &&
      needs.analyze.outputs.is_prerelease != 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Update major version tag
        env:
          TAG: ${{ github.event.release.tag_name }}
        run: |
          VERSION="${TAG#v}"
          MAJOR="${VERSION%%.*}"
          echo "Release tag: $TAG â†’ Major version tag: v$MAJOR"
          git tag -fa "v$MAJOR" -m "Release $TAG" HEAD
          git push origin "v$MAJOR" --force

  # ============================================================================
  # PUBLISH TO GITHUB PACKAGES
  # ============================================================================
  publish-nuget:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: [analyze, pack]
    if: |
      needs.analyze.outputs.should_release == 'true' &&
      needs.pack.result == 'success'
    permissions:
      packages: write
    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: versionizer-${{ needs.analyze.outputs.version }}
          path: packages

      - name: Preview NuGet Publish
        run: |
          echo "=========================================="
          echo "NUGET PUBLISH PREVIEW"
          echo "=========================================="
          echo ""
          echo "  Package:  $(ls packages/*.nupkg)"
          echo "  Version:  ${{ needs.analyze.outputs.version }}"
          echo "  Source:   ${{ env.NUGET_SOURCE }}"
          echo ""
          if [[ "${{ inputs.dry_run }}" != "false" ]]; then
            echo "DRY RUN - Skipping actual NuGet push"
          else
            echo "Will push to GitHub Packages"
          fi
          echo "=========================================="

      - name: Push to GitHub Packages
        if: ${{ !inputs.dry_run }}
        run: |
          dotnet nuget push packages/*.nupkg \
            --source "${{ env.NUGET_SOURCE }}" \
            --api-key "${{ secrets.GITHUB_TOKEN }}" \
            --skip-duplicate

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [analyze, validate-version, pack, changelog, create-prerelease, upload-to-release, update-major-tag, publish-nuget]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate Summary
        uses: ./workflow-summary
        with:
          version: ${{ needs.analyze.outputs.version }}
          is-prerelease: ${{ needs.analyze.outputs.is_prerelease }}
          semver: ${{ needs.analyze.outputs.semver }}
          full-semver: ${{ needs.analyze.outputs.full_semver }}
          prerelease-number: ${{ needs.analyze.outputs.prerelease_number }}
          commits-since: ${{ needs.analyze.outputs.commits_since }}
          should-release: ${{ needs.analyze.outputs.should_release }}
          is-manual-release: ${{ needs.analyze.outputs.is_manual_release }}
          skip-reason: ${{ needs.analyze.outputs.skip_reason }}
          changelog: ${{ needs.changelog.outputs.content }}
          job-results: |
            Analyze Changes=${{ needs.analyze.result }}
            Validate Version=${{ needs.validate-version.result }}
            Pack NuGet=${{ needs.pack.result }}
            Changelog=${{ needs.changelog.result }}
            Create Prerelease=${{ needs.create-prerelease.result }}
            Upload to Release=${{ needs.upload-to-release.result }}
            Update Major Tag=${{ needs.update-major-tag.result }}
            Publish to GitHub Packages=${{ needs.publish-nuget.result }}
          additional-sections: |
            ### NuGet Package

            - **Package ID**: Versionizer
            - **Version**: `${{ needs.analyze.outputs.version }}`
            - **Feed**: `${{ env.NUGET_SOURCE }}`
            - **Config Source**: `${{ needs.analyze.outputs.config_source }}`
